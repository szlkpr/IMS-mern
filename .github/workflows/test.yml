name: Comprehensive Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM

jobs:
  # Backend Tests
  backend-tests:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci
    
    - name: Run Backend Unit Tests
      run: |
        cd backend
        npm run test:unit
    
    - name: Run Backend Integration Tests
      run: |
        cd backend
        npm run test:integration
    
    - name: Generate Backend Coverage Report
      run: |
        cd backend
        npm run test:coverage
    
    - name: Upload Backend Coverage
      uses: codecov/codecov-action@v3
      with:
        file: backend/coverage/lcov.info
        flags: backend
        name: backend-coverage

  # Frontend Tests
  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Frontend Dependencies
      run: npm ci
    
    - name: Run Frontend Unit Tests
      run: npm run test:run
    
    - name: Run Frontend Component Tests
      run: npm run test:run -- --reporter=verbose
    
    - name: Generate Frontend Coverage Report
      run: npm run test:coverage
    
    - name: Upload Frontend Coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # ML Service Tests
  ml-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install ML Service Dependencies
      run: |
        cd ml-service
        pip install -r requirements.txt
    
    - name: Run ML Service Tests
      run: |
        cd ml-service
        python -m pytest tests/ -v --cov=app --cov-report=xml
    
    - name: Upload ML Service Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ml-service/coverage.xml
        flags: ml-service
        name: ml-service-coverage

  # E2E Tests
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, ml-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: |
        npm ci
        cd backend && npm ci
        cd ../ml-service && pip install -r requirements.txt
        cd ../e2e && npm ci
    
    - name: Install Playwright Browsers
      run: |
        cd e2e
        npx playwright install --with-deps
    
    - name: Start Services
      run: |
        # Start backend
        cd backend && npm run dev &
        BACKEND_PID=$!
        
        # Start ML service
        cd ../ml-service && python -m uvicorn app:app --port 8000 &
        ML_PID=$!
        
        # Start frontend
        npm run dev &
        FRONTEND_PID=$!
        
        # Wait for services
        sleep 30
        
        # Save PIDs for cleanup
        echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
        echo "ML_PID=$ML_PID" >> $GITHUB_ENV
        echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
    
    - name: Run E2E Tests
      run: |
        cd e2e
        npx playwright test
    
    - name: Upload E2E Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: e2e/test-results/
    
    - name: Cleanup Services
      if: always()
      run: |
        kill $BACKEND_PID $ML_PID $FRONTEND_PID || true

  # Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, ml-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: |
        npm ci
        cd backend && npm ci
        cd ../ml-service && pip install -r requirements.txt
    
    - name: Start Services
      run: |
        # Start backend
        cd backend && npm run dev &
        BACKEND_PID=$!
        
        # Start ML service
        cd ../ml-service && python -m uvicorn app:app --port 8000 &
        ML_PID=$!
        
        # Start frontend
        npm run dev &
        FRONTEND_PID=$!
        
        # Wait for services
        sleep 30
        
        # Save PIDs for cleanup
        echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
        echo "ML_PID=$ML_PID" >> $GITHUB_ENV
        echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
    
    - name: Run Performance Tests
      run: |
        # Install artillery for load testing
        npm install -g artillery
        
        # Create performance test config
        cat > artillery-config.yml << EOF
        config:
          target: 'http://localhost:4200'
          phases:
            - duration: 60
              arrivalRate: 10
        scenarios:
          - name: "API Load Test"
            weight: 100
            flow:
              - get:
                  url: "/api/v1/products"
              - get:
                  url: "/api/v1/sales"
              - get:
                  url: "/api/v1/analytics/dashboard"
        EOF
        
        # Run load test
        artillery run artillery-config.yml --output performance-report.json
    
    - name: Upload Performance Report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance-report.json
    
    - name: Cleanup Services
      if: always()
      run: |
        kill $BACKEND_PID $ML_PID $FRONTEND_PID || true

  # Security Tests
  security-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Dependencies
      run: |
        npm ci
        cd backend && npm ci
    
    - name: Run Security Audit
      run: |
        npm audit --audit-level moderate
        cd backend && npm audit --audit-level moderate
    
    - name: Run Dependency Check
      run: |
        npm install -g npm-check-updates
        npx npm-check-updates --doctor
        cd backend && npx npm-check-updates --doctor

  # Test Summary
  test-summary:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, ml-tests, e2e-tests, performance-tests, security-tests]
    if: always()
    
    steps:
    - name: Test Summary
      run: |
        echo "## ðŸ§ª Test Suite Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | ${{ needs.backend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | ${{ needs.frontend-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ML Service Tests | ${{ needs.ml-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Tests | ${{ needs.security-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Coverage Reports" >> $GITHUB_STEP_SUMMARY
        echo "- Backend: backend/coverage/index.html" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend: coverage/index.html" >> $GITHUB_STEP_SUMMARY
        echo "- ML Service: ml-service/htmlcov/index.html" >> $GITHUB_STEP_SUMMARY
        echo "- E2E: e2e/test-results/index.html" >> $GITHUB_STEP_SUMMARY


